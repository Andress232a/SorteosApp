const express = require('express');
const { pool } = require('../config/database');
const { authenticateToken, isAdmin } = require('../middleware/auth');

const router = express.Router();

// Todas las rutas requieren autenticación y ser admin
router.use(authenticateToken);
router.use(isAdmin);

// Estadísticas del dashboard
router.get('/stats', async (req, res) => {
  try {
    // Total de usuarios
    const [usuarios] = await pool.execute('SELECT COUNT(*) as total FROM usuarios');
    const total_usuarios = usuarios[0].total;

    // Total de sorteos
    const [sorteos] = await pool.execute('SELECT COUNT(*) as total FROM sorteos');
    const total_sorteos = sorteos[0].total;

    // Total de tickets
    const [tickets] = await pool.execute('SELECT COUNT(*) as total FROM tickets');
    const total_tickets = tickets[0].total;

    // Tickets vendidos
    const [vendidos] = await pool.execute(
      "SELECT COUNT(*) as total FROM tickets WHERE estado = 'vendido'"
    );
    const tickets_vendidos = vendidos[0].total;

    // Ingresos totales
    const [ingresos] = await pool.execute(`
      SELECT COALESCE(SUM(monto), 0) as total 
      FROM pagos 
      WHERE estado = 'completado'
    `);
    const ingresos_totales = ingresos[0].total || 0;

    // Sorteos activos
    const [activos] = await pool.execute(
      "SELECT COUNT(*) as total FROM sorteos WHERE estado = 'activo'"
    );
    const sorteos_activos = activos[0].total;

    res.json({
      total_usuarios,
      total_sorteos,
      total_tickets,
      tickets_vendidos,
      ingresos_totales: parseFloat(ingresos_totales),
      sorteos_activos,
    });
  } catch (error) {
    console.error('Error al obtener estadísticas:', error);
    res.status(500).json({ error: 'Error al obtener estadísticas' });
  }
});

// Obtener todos los usuarios
router.get('/usuarios', async (req, res) => {
  try {
    const [usuarios] = await pool.execute(`
      SELECT id, nombre, email, telefono, rol, created_at
      FROM usuarios
      ORDER BY created_at DESC
    `);
    res.json(usuarios);
  } catch (error) {
    console.error('Error al obtener usuarios:', error);
    res.status(500).json({ error: 'Error al obtener usuarios' });
  }
});

// Actualizar rol de usuario
router.put('/usuarios/:id/rol', async (req, res) => {
  try {
    const { id } = req.params;
    const { rol } = req.body;

    if (!['usuario', 'admin'].includes(rol)) {
      return res.status(400).json({ error: 'Rol inválido' });
    }

    await pool.execute('UPDATE usuarios SET rol = ? WHERE id = ?', [rol, id]);
    res.json({ message: 'Rol actualizado correctamente' });
  } catch (error) {
    console.error('Error al actualizar rol:', error);
    res.status(500).json({ error: 'Error al actualizar rol' });
  }
});

// Obtener todos los tickets con información del sorteo
router.get('/tickets', async (req, res) => {
  try {
    const { DB_TYPE } = require('../config/database');
    
    let query;
    if (DB_TYPE === 'postgres') {
      // PostgreSQL: convertir a INTEGER para ordenar numéricamente
      query = `
        SELECT 
          t.*,
          s.titulo as sorteo_titulo
        FROM tickets t
        JOIN sorteos s ON t.sorteo_id = s.id
        ORDER BY 
          s.titulo ASC,
          CAST(t.numero_ticket AS INTEGER),
          t.numero_ticket ASC
      `;
    } else {
      // MySQL: convertir a UNSIGNED para ordenar numéricamente
      query = `
        SELECT 
          t.*,
          s.titulo as sorteo_titulo
        FROM tickets t
        JOIN sorteos s ON t.sorteo_id = s.id
        ORDER BY 
          s.titulo ASC,
          CAST(t.numero_ticket AS UNSIGNED),
          t.numero_ticket ASC
      `;
    }
    
    const [tickets] = await pool.execute(query);

    res.json(tickets);
  } catch (error) {
    console.error('Error al obtener tickets:', error);
    res.status(500).json({ error: 'Error al obtener tickets' });
  }
});

module.exports = router;

